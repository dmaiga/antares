{% extends 'base_candidate.html' %}
{% load static %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
<div class="container py-3">
  <!-- En-tête -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Tableau de bord</h1>
    <a href="{% url 'candidat_job_list' %}" class="btn btn-sm btn-orange">
      <i class="bi bi-search me-1"></i> Voir les offres
    </a>
  </div>

  <!-- Statistiques rapides -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body text-center">
          <h5 class="card-title mb-1">{{ diplomes.count }}</h5>
          <p class="card-text text-muted small">Diplômes</p>
          <a href="{% url 'diplome_list' %}" class="small text-primary-blue stretched-link">
            Voir tout <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body text-center">
          <h5 class="card-title mb-1">{{ experiences.count }}</h5>
          <p class="card-text text-muted small">Expériences</p>
          <a href="{% url 'experience_list' %}" class="small text-primary-blue stretched-link">
            Voir tout <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    </div>
    <!-- Remplacer l'ancienne section compétences par : -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-graduation-cap me-2"></i>
            Compétences acquises
        </h5>
    </div>
    <div class="card-body">
        {% if user.diplomes.exists %}
            <div class="row">
                {% for diplome in user.diplomes.all %}
                    {% if diplome.competences_acquises %}
                        <div class="col-md-6 mb-3">
                            <h6>{{ diplome.intitule }}</h6>
                            <div class="bg-light p-3 rounded">
                                {{ diplome.competences_acquises|safe }}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">Ajoutez vos diplômes pour voir vos compétences.</p>
        {% endif %}
    </div>
</div>
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body text-center">
          <h5 class="card-title mb-1">{{ candidatures.count }}</h5>
          <p class="card-text text-muted small">Candidatures</p>
          <a href="{% url 'candidature_list' %}" class="small text-primary-blue stretched-link">
            Voir tout <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Dernières candidatures -->
  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 h6">Mes dernières candidatures</h5>
      <a href="{% url 'candidature_list' %}" class="btn btn-sm btn-outline-primary">Voir tout</a>
    </div>
    <div class="card-body p-3">
      {% if candidatures %}
        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead>
              <tr>
                <th class="d-none d-md-table-cell">Offre</th>
                <th>Entreprise</th>
                <th class="d-none d-lg-table-cell">Date</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for candidature in candidatures|slice:":5" %}
                <tr>
                  <td class="d-none d-md-table-cell text-truncate" style="max-width: 150px;">{{ candidature.offre.titre }}</td>
                  <td class="text-truncate" style="max-width: 120px;">{{ candidature.offre.societe }}</td>
                  <td class="d-none d-lg-table-cell">{{ candidature.date_postulation|date:"d/m/Y" }}</td>
                  <td>
                    <span class="badge 
                      {% if candidature.statut == 'POST' %}bg-primary
                      {% elif candidature.statut == 'ENT' %}bg-warning
                      {% elif candidature.statut == 'ACC' %}bg-success
                      {% elif candidature.statut == 'REF' %}bg-danger
                      {% else %}bg-secondary{% endif %}">
                      {{ candidature.get_statut_display }}
                    </span>
                  </td>
                  <td class="text-end">
                    <a href="{% url 'candidature_detail' candidature.pk %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-eye"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info mb-0 small">
          Vous n'avez pas encore postulé à des offres.
          <a href="{% url 'candidat_job_list' %}" class="alert-link">Parcourir les offres</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Offres récentes -->
  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 h6">Offres récentes</h5>
      <a href="{% url 'candidat_job_list' %}" class="btn btn-sm btn-outline-primary">Voir tout</a>
    </div>
    <div class="card-body p-3">
      {% if offres_recentes %}
        <div class="row g-3">
          {% for offre in offres_recentes|slice:":4" %}
            <div class="col-12 col-md-6">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title h6 mb-1 text-truncate">{{ offre.titre }}</h5>
                  <h6 class="card-subtitle mb-2 text-muted small">{{ offre.societe }}</h6>
                  <p class="card-text text-muted small text-truncate" style="max-height: 3rem;">
                    {{ offre.mission_principale|striptags|truncatewords:15 }}
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary small">{{ offre.get_type_offre_display }}</span>
                    <div>
                      <a href="{% url 'public-job-offer-detail' offre.pk %}" class="btn btn-sm btn-outline-primary me-1">
                        Détails
                      </a>
                      {% if offre.deja_postule %}
                        <span class="badge bg-success small">Déjà postulé</span>
                      {% else %}
                        <a href="{% url 'apply_job' offre.id %}" class="btn btn-sm btn-orange">
                          Postuler
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="card-footer bg-transparent border-0 small text-muted">
                  Publiée le {{ offre.date_publication|date:"d/m/Y" }}
                  {% if offre.date_limite %}
                    <span class="float-end">Clôture : {{ offre.date_limite|date:"d/m/Y" }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info mb-0 small">
          Aucune offre disponible pour le moment.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Complétion du profil -->
  <div class="card border-0 shadow-sm">

      <div class="list-group list-group-flush">
        <a href="{% url 'edit_profil' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center small py-2">
          Informations personnelles
          <span class="badge {% if profil.is_personal_info_complete %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
            {% if profil.is_personal_info_complete %}Complet{% else %}À compléter{% endif %}
          </span>
        </a>
        <a href="{% url 'diplome_list' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center small py-2">
          Diplômes
          <span class="badge {% if diplomes.exists %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
            {% if diplomes.exists %}{{ diplomes.count }}{% else %}À ajouter{% endif %}
          </span>
        </a>
        <a href="{% url 'experience_list' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center small py-2">
          Expériences
          <span class="badge {% if experiences.exists %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
            {% if experiences.exists %}{{ experiences.count }}{% else %}À ajouter{% endif %}
          </span>
        </a>
        <a href="{% url 'competences_consolidees' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center small py-2">
          Compétences
          
          <span class="badge {% if competences.exists %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
            {% if competences.exists %}{{ competences.count }}{% else %}À ajouter{% endif %}
          </span>
        </a>
        <a href="{% url 'document_list' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center small py-2">
          Documents
          <span class="badge {% if documents.exists %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
            {% if documents.exists %}{{ documents.count }}{% else %}À ajouter{% endif %}
          </span>
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Activer les tooltips Bootstrap
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(tooltipTriggerEl => {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
      document.addEventListener("DOMContentLoaded", () => {
        const progressBar = document.getElementById("progress-bar");
        const completion = progressBar.dataset.completion;

        progressBar.style.width = completion + "%";
        progressBar.setAttribute("aria-valuenow", completion);
        progressBar.textContent = completion + "%";
    });
</script>
{% endblock %}