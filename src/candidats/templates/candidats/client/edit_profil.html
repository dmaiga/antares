{% extends 'base_candidate.html' %}
{% load static %}

{% block title %}Modifier mon profil{% endblock %}

{% block content %}
<div class="container py-3">
  <h1 class="h4 mb-3">Modifier mon profil</h1>

  <div class="row g-3">
    <!-- Formulaire principal -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Messages d'erreur globaux -->
            {% if user_form.errors or profil_form.errors or adresse_form.errors %}
              <div class="alert alert-danger">
                {{ user_form.errors }}
                {{ profil_form.errors }}
                {{ adresse_form.errors }}
              </div>
            {% endif %}
            
            <!-- Section 1: Photo et informations de base -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-person me-2"></i>Informations personnelles</h6>
              </div>
              <div class="card-body">
                <div class="row align-items-center mb-3">
                  <div class="col-12 col-md-4 text-center">
                    <div class="mb-2">
                      <img id="avatar-preview" 
                           src="{% if profil_form.instance.photo %}{{ profil_form.instance.photo.url }}{% else %}{% static 'images/default-avatar.jpg' %}{% endif %}" 
                           class="rounded-circle img-thumbnail" 
                           width="120" 
                           alt="Photo de profil">
                    </div>
                    <label for="id_photo" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-camera me-1"></i> Changer la photo
                    </label>
                    {{ profil_form.photo }}
                  </div>
                  <div class="col-12 col-md-8">
                    <div class="row">
                      <div class="col-12 col-md-6 mb-2">
                        <label for="id_first_name" class="form-label small">Prénom</label>
                        {{ user_form.first_name }}
                      </div>
                      <div class="col-12 col-md-6 mb-2">
                        <label for="id_last_name" class="form-label small">Nom</label>
                        {{ user_form.last_name }}
                      </div>
                    </div>
                    <div class="mb-2">
                      <label for="id_email" class="form-label small">Email</label>
                      {{ user_form.email }}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 col-md-4 mb-2">
                    <label for="id_date_naissance" class="form-label small">Date de naissance</label>
                    {{ profil_form.date_naissance }}
                  </div>
                  <div class="col-12 col-md-4 mb-2">
                    <label for="id_genre" class="form-label small">Genre</label>
                    {{ profil_form.genre }}
                  </div>
                  <div class="col-12 col-md-4 mb-2">
                    <label for="id_situation_familiale" class="form-label small">Situation familiale</label>
                    {{ profil_form.situation_familiale }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 2: Coordonnées -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-telephone me-2"></i>Coordonnées</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_telephone" class="form-label small">Téléphone principal</label>
                    {{ profil_form.telephone }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_telephone_second" class="form-label small">Téléphone secondaire</label>
                    {{ profil_form.telephone_second }}
                  </div>
                </div>

               
                
                <div class="row">
                  
                  <div class="col-12 col-md-4 mb-2">
                    <label for="id_pays" class="form-label small">Pays</label>
                    {{ adresse_form.pays }}
                  </div>
                  <div class="col-12 col-md-4 mb-2">
                    <label for="id_ville" class="form-label small">Ville</label>
                    {{ adresse_form.ville }}
                  </div>
                  
                  
                <div class="col-12 col-md-4 mb-2">
                  <label for="quartier" class="form-label small">Quartier</label>
                  {{ adresse_form.quartier }}
                </div>
                </div>
              </div>
            </div>

            <!-- Section 3: Pièce d'identité -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-card-text me-2"></i>Pièce d'identité</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_type_piece_identite" class="form-label small">Type de pièce</label>
                    {{ profil_form.type_piece_identite }}
                    {% if profil_form.type_piece_identite.errors %}
                      <div class="text-danger small">{{ profil_form.type_piece_identite.errors }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_numero_piece_identite" class="form-label small">Numéro de la pièce</label>
                    {{ profil_form.numero_piece_identite }}
                    {% if profil_form.numero_piece_identite.errors %}
                      <div class="text-danger small">{{ profil_form.numero_piece_identite.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_date_delivrance_piece" class="form-label small">Date de délivrance</label>
                    {{ profil_form.date_delivrance_piece }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_lieu_delivrance_piece" class="form-label small">Lieu de délivrance</label>
                    {{ profil_form.lieu_delivrance_piece }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 4: Préférences professionnelles -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-briefcase me-2"></i>Préférences professionnelles</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_pretention_salariale" class="form-label small">Prétention salariale (FCFA)</label>
                    {{ profil_form.pretention_salariale }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_localite_souhaitee" class="form-label small">Localité souhaitée</label>
                    {{ profil_form.localite_souhaitee }}
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 col-md-4 mb-2">
                    <div class="form-check form-switch">
                      {{ profil_form.disponible }}
                      <label class="form-check-label small" for="id_disponible">Disponible immédiatement</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-4 mb-2">
                    <div class="form-check form-switch">
                      {{ profil_form.mission_temporaire }}
                      <label class="form-check-label small" for="id_mission_temporaire">Missions temporaires</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-4 mb-2">
                    <div class="form-check form-switch">
                      {{ profil_form.recherche_active }}
                      <label class="form-check-label small" for="id_recherche_active">En recherche active</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 5: Réseaux sociaux et portfolio -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Présence en ligne</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_linkedin_url" class="form-label small">LinkedIn</label>
                    {{ profil_form.linkedin_url }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_facebook_url" class="form-label small">Facebook</label>
                    {{ profil_form.facebook_url }}
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_instagram_url" class="form-label small">Instagram</label>
                    {{ profil_form.instagram_url }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_portfolio_url" class="form-label small">Portfolio</label>
                    {{ profil_form.portfolio_url }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 6: Préférences de communication -->
            <div class="card mb-4 border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Préférences de communication</h6>
              </div>
              <div class="card-body">
                <div class="form-check form-switch mb-2">
                  {{ profil_form.accepte_newsletter }}
                  <label class="form-check-label small" for="id_accepte_newsletter">Recevoir les offres exclusives par email</label>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <a href="{% url 'dashboard_candidat' %}" class="btn btn-outline-secondary">Annuler</a>
              <button type="submit" class="btn btn-orange">Enregistrer les modifications</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Actions rapides -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm " style="top: 20px;">
        <div class="card-header bg-white border-0">
          <h5 class="h6 mb-0">Actions rapides</h5>
        </div>
        <div class="card-body p-3">
          <div class="d-grid gap-2">
            <a href="{% url 'diplome_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-mortarboard-fill me-2"></i> Gérer mes diplômes
            </a>
            <a href="{% url 'experience_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-briefcase-fill me-2"></i> Gérer mes expériences
            </a>
            <a href="#" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-tools me-2"></i> Gérer mes compétences
            </a>
            <a href="{% url 'document_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-file-earmark-text me-2"></i> Gérer mes documents
            </a>
            <a href="{% url 'password_change' %}" class="btn btn-warning btn-sm">Changer mon mot de passe</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Gestion de l'aperçu de la photo
    const avatarInput = document.getElementById('id_photo');
    const avatarPreview = document.getElementById('avatar-preview');

    if (avatarInput && avatarPreview) {
      avatarInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            avatarPreview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      avatarPreview.addEventListener('click', function () {
        avatarInput.click();
      });
    }

    // Affichage conditionnel pour les champs liés
    const typePiece = document.getElementById('id_type_piece_identite');
    const numeroPiece = document.getElementById('id_numero_piece_identite');
    const dateDelivrance = document.getElementById('id_date_delivrance_piece').closest('.mb-2');
    const lieuDelivrance = document.getElementById('id_lieu_delivrance_piece').closest('.mb-2');
    
    function togglePieceFields() {
      const hasValue = typePiece.value || numeroPiece.value;
      dateDelivrance.style.display = hasValue ? 'block' : 'none';
      lieuDelivrance.style.display = hasValue ? 'block' : 'none';
    }
    
    if (typePiece && numeroPiece) {
      typePiece.addEventListener('change', togglePieceFields);
      numeroPiece.addEventListener('input', togglePieceFields);
      // Initial state
      togglePieceFields();
    }
  });
</script>
{% endblock %}