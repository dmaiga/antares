{% extends 'base_candidate.html' %}
{% load static %}

{% block title %}Modifier mon profil{% endblock %}

{% block content %}
<div class="container py-3">
  <h1 class="h4 mb-3">Modifier mon profil</h1>

  <div class="row g-3">
    <!-- Formulaire principal -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="h6 mb-0">Informations personnelles</h5>
        </div>
        <div class="card-body p-3">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- Messages d'erreur globaux -->
            {% if user_form.errors or profil_form.errors or adresse_form.errors %}
              <div class="alert alert-danger">
                {{ user_form.errors }}
                {{ profil_form.errors }}
                {{ adresse_form.errors }}
              </div>
            {% endif %}
            
            <!-- Avatar + infos de base -->
            <div class="row align-items-center mb-3">
              <div class="col-12 col-md-4 text-center">
                <div class="mb-2">
                  <img id="avatar-preview" 
                       src="{% if profil_form.instance.photo %}{{ profil_form.instance.photo.url }}{% else %}{% static 'images/default-avatar.jpg' %}{% endif %}" 
                       class="rounded-circle img-thumbnail" 
                       width="120" 
                       alt="Photo de profil">
                </div>
                <label for="photo-input" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-camera me-1"></i> Changer la photo
                </label>
                {{ profil_form.photo }}
              </div>
              <div class="col-12 col-md-8">
                <div class="row">
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_first_name" class="form-label small">Prénom</label>
                    {{ user_form.first_name }}
                  </div>
                  <div class="col-12 col-md-6 mb-2">
                    <label for="id_last_name" class="form-label small">Nom</label>
                    {{ user_form.last_name }}
                  </div>
                </div>
                <div class="mb-2">
                  <label for="id_email" class="form-label small">Email</label>
                  {{ user_form.email }}
                </div>
                <div class="mb-2">
                  <label for="id_telephone" class="form-label small">Téléphone</label>
                  {{ profil_form.telephone }}
                </div>
              </div>
            </div>

            <!-- Date de naissance & genre -->
            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <label for="id_date_naissance" class="form-label small">Date de naissance</label>
                {{ profil_form.date_naissance }}
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="id_genre" class="form-label small">Genre</label>
                {{ profil_form.genre }}
              </div>
            </div>

            <!-- Adresse -->
            <div class="mb-2">
              <label for="id_ligne1" class="form-label small">Adresse (Ligne 1)</label>
              {{ adresse_form.ligne1 }}
            </div>
            <div class="mb-2">
              <label for="id_ligne2" class="form-label small">Adresse (Ligne 2)</label>
              {{ adresse_form.ligne2 }}
            </div>
            <div class="row">
              <div class="col-12 col-md-4 mb-2">
                <label for="id_ville" class="form-label small">Ville</label>
                {{ adresse_form.ville }}
              </div>
              <div class="col-12 col-md-4 mb-2">
                <label for="id_code_postal" class="form-label small">Code postal</label>
                {{ adresse_form.code_postal }}
              </div>
              <div class="col-12 col-md-4 mb-2">
                <label for="id_pays" class="form-label small">Pays</label>
                {{ adresse_form.pays }}
              </div>
            </div>

            <!-- Salaire -->
            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <label for="id_salaire_min" class="form-label small">Salaire minimum (€)</label>
                {{ profil_form.salaire_min }}
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="id_salaire_max" class="form-label small">Salaire maximum (€)</label>
                {{ profil_form.salaire_max }}
              </div>
            </div>

            <!-- Disponibilité & mobilité -->
            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <div class="form-check">
                  {{ profil_form.disponible }}
                  <label class="form-check-label small" for="id_disponible">Disponible immédiatement</label>
                </div>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <div class="form-check">
                  {{ profil_form.mobilite_geographique }}
                  <label class="form-check-label small" for="id_mobilite_geographique">Mobilité géographique</label>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label for="id_rayon_mobilite" class="form-label small">Rayon de mobilité (km)</label>
              {{ profil_form.rayon_mobilite }}
            </div>

            <!-- Liens professionnels -->
            <div class="mb-2">
              <label for="id_linkedin_url" class="form-label small">Profil LinkedIn</label>
              {{ profil_form.linkedin_url }}
            </div>
            <div class="mb-2">
              <label for="id_portfolio_url" class="form-label small">Portfolio</label>
              {{ profil_form.portfolio_url }}
            </div>

            <!-- Recherche active -->
            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <div class="form-check">
                  {{ profil_form.recherche_active }}
                  <label class="form-check-label small" for="id_recherche_active">En recherche active</label>
                </div>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="id_date_debut_recherche" class="form-label small">Date début recherche</label>
                {{ profil_form.date_debut_recherche }}
              </div>
            </div>

            <!-- Compétences -->
            <div class="mb-2">
              <label for="id_competences" class="form-label small">Compétences</label>
              {{ profil_form.competences }}
            </div>

            <!-- Newsletter -->
            <div class="mb-3">
              <div class="form-check">
                {{ profil_form.accepte_newsletter }}
                <label class="form-check-label small" for="id_accepte_newsletter">Recevoir les offres exclusives par email</label>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2">
              <a href="{% url 'dashboard_candidat' %}" class="btn btn-sm btn-outline-secondary">Annuler</a>
              <button type="submit" class="btn btn-sm btn-orange">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- État de complétion et actions rapides -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-white border-0">
          <h5 class="h6 mb-0">État de complétion</h5>
        </div>
        <div class="card-body p-3">
          {% with completion=profil.get_completion_percentage %}
            <div class="mb-3">
              <div class="d-flex justify-content-between small mb-1">
                <span>Profil complété à {{ completion }}%</span>
                <span>{{ completion }}%</span>
              </div>
              <div class="progress" style="height: 20px;">
                <div id="progress-bar" 
                     class="progress-bar progress-bar-striped bg-success" 
                     role="progressbar" 
                     data-completion="{{ completion }}"
                     style="width: 0%;" 
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100">0%</div>
              </div>
            </div>
          {% endwith %}
          <div class="list-group list-group-flush">
            <div class="list-group-item d-flex justify-content-between align-items-center small py-2">
              Informations personnelles
              <span class="badge {% if user_form.first_name.value and user_form.last_name.value and user_form.email.value %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                {% if user_form.first_name.value and user_form.last_name.value and user_form.email.value %}Complet{% else %}Incomplet{% endif %}
              </span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center small py-2">
              Coordonnées
              <span class="badge {% if profil_form.telephone.value and adresse_form.ligne1.value %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                {% if profil_form.telephone.value and adresse_form.ligne1.value %}Complet{% else %}Incomplet{% endif %}
              </span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center small py-2">
              Photo de profil
              <span class="badge {% if profil_form.photo.value %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                {% if profil_form.photo.value %}Complet{% else %}Incomplet{% endif %}
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="h6 mb-0">Actions rapides</h5>
        </div>
        <div class="card-body p-3">
          <div class="d-grid gap-2">
            <a href="{% url 'diplome_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-mortarboard-fill me-2"></i> Gérer mes diplômes
            </a>
            <a href="{% url 'experience_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-briefcase-fill me-2"></i> Gérer mes expériences
            </a>
            <a href="#" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-tools me-2"></i> Gérer mes compétences
            </a>
            <a href="{% url 'document_list' %}" class="btn btn-sm btn-outline-primary text-start">
              <i class="bi bi-file-earmark-text me-2"></i> Gérer mes documents
            </a>
            <a href="{% url 'password_change' %}" class="btn btn-warning">Changer mon mot de passe</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const avatarInput = document.getElementById('id_photo');
    const avatarPreview = document.getElementById('avatar-preview');

    if (avatarInput && avatarPreview) {
      avatarInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            avatarPreview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      avatarPreview.addEventListener('click', function () {
        avatarInput.click();
      });
    }

    const progressBar = document.getElementById("progress-bar");
    if (progressBar) {
      const completion = progressBar.dataset.completion;
      progressBar.style.width = completion + "%";
      progressBar.setAttribute("aria-valuenow", completion);
      progressBar.textContent = completion + "%";
    }
  });
</script>
{% endblock %}
