{% extends 'base_candidate.html' %}
{% load static %}

{% block title %}Postuler à {{ offre.titre }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'candidat_job_list' %}">Offres d'emploi</a></li>
                    <li class="breadcrumb-item"><a href="{{ offre.get_absolute_url }}">{{ offre.titre|truncatewords:3 }}</a></li>
                    <li class="breadcrumb-item active">Postuler</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-paper-plane me-2"></i>Postuler à l'offre
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Offre Summary -->
                    <div class="alert alert-info">
                        <h5 class="alert-heading">{{ offre.titre }}</h5>
                        <p class="mb-1"><strong>Entreprise:</strong> {{ offre.entreprise.nom }}</p>
                        <p class="mb-1"><strong>Lieu:</strong> {{ offre.lieu }}</p>
                        <p class="mb-0"><strong>Type de contrat:</strong> {{ offre.get_type_contrat_display }}</p>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="mb-3 required-field">
                            <label for="{{ form.cv.id_for_label }}" class="form-label">{{ form.cv.label }}</label>
                            {{ form.cv }}
                            {% if form.cv.errors %}
                                <div class="text-danger">
                                    {% for error in form.cv.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Sélectionnez le CV que vous souhaitez envoyer pour cette candidature.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.lettre_motivation.id_for_label }}" class="form-label">{{ form.lettre_motivation.label }}</label>
                            {{ form.lettre_motivation }}
                            {% if form.lettre_motivation.errors %}
                                <div class="text-danger">
                                    {% for error in form.lettre_motivation.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Rédigez une lettre de motivation personnalisée pour cette offre. 
                                <a href="#" data-bs-toggle="modal" data-bs-target="#motivationTips">Conseils d'écriture</a>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Documents joints</label>
                            <div class="border p-3 rounded">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" checked disabled>
                                    <label class="form-check-label">
                                        CV sélectionné
                                    </label>
                                </div>
                                {% if user.documents.all %}
                                    <div class="mt-2">
                                        <label class="form-label">Ajouter d'autres documents:</label>
                                        {% for doc in user.documents.all %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="documents" value="{{ doc.pk }}" id="doc_{{ doc.pk }}">
                                                <label class="form-check-label" for="doc_{{ doc.pk }}">
                                                    {{ doc.titre }} ({{ doc.get_type_display }})
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-paper-plane me-1"></i> Envoyer la candidature
                            </button>
                            <a href="{{ offre.get_absolute_url }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les conseils de lettre de motivation -->
<div class="modal fade" id="motivationTips" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conseils pour votre lettre de motivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">✅ Personnalisez la lettre pour cette offre spécifique</li>
                    <li class="list-group-item">✅ Mentionnez pourquoi vous êtes intéressé par cette entreprise</li>
                    <li class="list-group-item">✅ Mettez en avant vos compétences en lien avec le poste</li>
                    <li class="list-group-item">✅ Soyez concis (300-500 mots maximum)</li>
                    <li class="list-group-item">✅ Relisez-vous pour corriger les fautes d'orthographe</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Bootstrap classes to form elements
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            if (input.type !== 'checkbox' && input.type !== 'hidden') {
                input.classList.add('form-control');
            }
        });
        
        // Style the select elements
        const selectElements = document.querySelectorAll('select');
        selectElements.forEach(select => {
            select.classList.add('form-select');
        });
        
        // Style the textarea
        const textarea = document.querySelector('textarea');
        if (textarea) {
            textarea.classList.add('form-control');
            textarea.rows = 8;
            textarea.placeholder = "Madame, Monsieur,\n\nJe me permets de vous soumettre ma candidature...";
        }
        
        // Style checkboxes
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                checkbox.classList.add('form-check-input');
            }
        });
    });
</script>
{% endblock %}