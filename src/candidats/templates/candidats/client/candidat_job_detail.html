{% extends 'base_candidate.html' %}
{% load static %}

{% block title %}{{ offre.titre }} - {{ offre.societe }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'candidat_job_list' %}" class="text-decoration-none">
                    <i class="fas fa-arrow-left me-2"></i>Retour aux offres
                </a>
            </li>
            <li class="breadcrumb-item active text-truncate" style="max-width: 200px;">
                {{ offre.titre }}
            </li>
        </ol>
    </nav>

    <div class="row">
        <!-- Contenu principal -->
        <div class="col-lg-9 col-md-7 mb-4">
            <!-- Header de l'offre -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-primary text-white py-4 position-relative">
                    <!-- Badge de type d'offre positionné en haut à droite -->
                    <span class="badge position-absolute top-0 end-0 m-3 
                        {% if offre.type_offre == 'emploi' %}bg-success
                        {% elif offre.type_offre == 'appel_offre' %}bg-info
                        {% else %}bg-secondary{% endif %} fs-6">
                        {{ offre.get_type_offre_display }}
                    </span>
                    
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="mb-3 mb-md-0 pe-4">
                            <h1 class="h3 mb-2 fw-bold">{{ offre.titre }}</h1>
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <span class="badge bg-white text-dark fs-6">
                                    <i class="fas fa-building me-1"></i>{{ offre.societe }}
                                </span>
                                {% if offre.lieu %}
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ offre.lieu }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <span class="badge bg-light text-dark fs-6 px-3 py-2">
                            <i class="fas fa-hashtag me-1"></i>{{ offre.reference }}
                        </span>
                    </div>
                </div>

                <!-- Métadonnées importantes - NOUVELLE VERSION -->
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Type d'offre -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-briefcase text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Type</small>
                                    <strong class="text-primary">{{ offre.get_type_offre_display }}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Salaire -->
                        {% if offre.salaire %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-success bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-euro-sign text-success"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Salaire</small>
                                    <strong>{{ offre.salaire }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Niveau d'étude -->
                        {% if offre.niveau_etude %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-info bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-graduation-cap text-info"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Niveau</small>
                                    <strong>{{ offre.niveau_etude }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Expérience requise -->
                        {% if offre.experience_requise %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-warning bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-clock text-warning"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Expérience</small>
                                    <strong>{{ offre.experience_requise }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Date de publication -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-secondary bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-calendar-plus text-secondary"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Publication</small>
                                    <strong>{{ offre.date_publication|date:"d/m/Y" }}</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Date de clôture -->
                        {% if offre.date_limite %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="{% if offre.est_expiree_db %}bg-danger bg-opacity-10{% else %}bg-secondary bg-opacity-10{% endif %} p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-calendar-times {% if offre.est_expiree_db %}text-danger{% else %}text-secondary{% endif %}"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Clôture</small>
                                    <strong class="{% if offre.est_expiree_db %}text-danger{% endif %}">
                                        {{ offre.date_limite|date:"d/m/Y" }}
                                    </strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Nombre de postes -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded-3 h-100">
                                <div class="bg-dark bg-opacity-10 p-2 rounded-circle me-3 flex-shrink-0">
                                    <i class="fas fa-users text-dark"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Postes</small>
                                    <strong>{{ offre.nombre_candidat }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenu détaillé avec onglets -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <ul class="nav nav-tabs nav-justified mb-4" id="offreTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mission-tab" data-bs-toggle="tab" data-bs-target="#mission" type="button" role="tab">
                                <i class="fas fa-bullseye me-2"></i>Mission
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profil-tab" data-bs-toggle="tab" data-bs-target="#profil" type="button" role="tab">
                                <i class="fas fa-user-tie me-2"></i>Profil
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="competences-tab" data-bs-toggle="tab" data-bs-target="#competences" type="button" role="tab">
                                <i class="fas fa-cogs me-2"></i>Compétences
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="conditions-tab" data-bs-toggle="tab" data-bs-target="#conditions" type="button" role="tab">
                                <i class="fas fa-file-contract me-2"></i>Conditions
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="offreTabsContent">
                        <!-- Mission -->
                        <div class="tab-pane fade show active" id="mission" role="tabpanel">
                            {% if offre.mission_principale %}
                                <div class="content-box">
                                    {{ offre.mission_principale|safe }}
                                </div>
                            {% endif %}
                            {% if offre.taches %}
                                <h6 class="mt-4 text-primary">Tâches principales :</h6>
                                <div class="content-box">
                                    {{ offre.taches|safe }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Profil -->
                        <div class="tab-pane fade" id="profil" role="tabpanel">
                            {% if offre.profil_recherche %}
                                <div class="content-box">
                                    {{ offre.profil_recherche|safe }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Compétences -->
                        <div class="tab-pane fade" id="competences" role="tabpanel">
                            {% if offre.competences_qualifications %}
                                <div class="content-box">
                                    {{ offre.competences_qualifications|safe }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Conditions -->
                        <div class="tab-pane fade" id="conditions" role="tabpanel">
                            {% if offre.conditions %}
                                <div class="content-box">
                                    {{ offre.conditions|safe }}
                                </div>
                            {% endif %}
                            {% if offre.comment_postuler %}
                                <h6 class="mt-4 text-primary">Comment postuler :</h6>
                                <div class="content-box">
                                    {{ offre.comment_postuler|safe }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Actions -->
        <div class="col-lg-3 col-md-5">
            <div class="sticky-top" style="top: 100px; z-index: 1000;">
                <!-- CTA Principal -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body text-center">
                        {% if deja_postule %}
                            <div class="alert alert-success border-0">
                                <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                                <h6 class="fw-bold">Candidature envoyée</h6>
                                <p class="small mb-2">Le {{ candidature.date_postulation|date:"d/m/Y" }}</p>
                                <a href="{% url 'candidature_detail' candidature.pk %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Voir ma candidature
                                </a>
                            </div>
                        {% else %}
    <a href="{% url 'apply_job' offre.pk %}" class="btn btn-primary btn-lg w-100 mb-3 py-3 {% if offre.est_expiree_db %}disabled{% endif %}">
        <i class="fas fa-paper-plane me-2"></i>
        {% if offre.est_expiree_db %}Offre expirée{% else %}Postuler maintenant{% endif %}
    </a>
    <p class="text-muted small">
        <i class="fas fa-clock me-1"></i>
        {% if offre.date_limite %}
            {% if offre.est_expiree_db %}
                Offre expirée depuis le {{ offre.date_limite|date:"d/m/Y" }}
            {% else %}
                Clôture le {{ offre.date_limite|date:"d/m/Y" }}
            {% endif %}
        {% else %}
            Offre à pourvoir rapidement
        {% endif %}
    </p>
{% endif %}
                    </div>
                </div>

                <!-- Informations de contact -->
                {% if offre.contact or offre.fichier_pdf %}
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations</h6>
                    </div>
                    <div class="card-body">
                        {% if offre.contact %}
                        <div class="mb-3">
                            <h6 class="small text-muted mb-2">Contact</h6>
                            <a href="mailto:{{ offre.contact }}" class="btn btn-outline-secondary btn-sm w-100 text-start">
                                <i class="fas fa-envelope me-2"></i>{{ offre.contact }}
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if offre.fichier_pdf %}
                        <div>
                            <h6 class="small text-muted mb-2">Document</h6>
                            <a href="{{ offre.fichier_pdf.url }}" class="btn btn-outline-primary btn-sm w-100 text-start" target="_blank">
                                <i class="fas fa-download me-2"></i>Télécharger l'offre PDF
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Partage -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-share-alt me-2"></i>Partager</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm share-btn" data-platform="linkedin">
                                <i class="fab fa-linkedin me-2"></i>LinkedIn
                            </button>
                            <button class="btn btn-outline-primary btn-sm share-btn" data-platform="facebook">
                                <i class="fab fa-facebook me-2"></i>Facebook
                            </button>
                            <button class="btn btn-outline-primary btn-sm share-btn" data-platform="email">
                                <i class="fas fa-envelope me-2"></i>Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 2rem;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    }
    
    .content-box {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        border-left: 4px solid #0d6efd;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        padding: 1rem 0.5rem;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom-color: #0d6efd;
        color: #0d6efd;
        background: transparent;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link:hover {
        border-bottom-color: #0d6efd;
        color: #0d6efd;
    }
    
    /* Styles pour les métadonnées */
    .metadata-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .metadata-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs .nav-item {
            min-width: 120px;
        }
        
        .content-box {
            padding: 1rem;
        }
        
        .sticky-top {
            position: relative;
            top: 0 !important;
        }
    }
</style>

<script>
    // Partage sur les réseaux sociaux
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const platform = this.dataset.platform;
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent('{{ offre.titre }} - {{ offre.societe }}');
            
            let shareUrl;
            switch(platform) {
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'email':
                    shareUrl = `mailto:?subject=${title}&body=Je vous partage cette offre: ${url}`;
                    break;
            }
            
            window.open(shareUrl, '_blank');
        });
    });
</script>
{% endblock %}